<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[atomic-penguin's personal webpage.]]></title>
  <link href="http://atomic-penguin.github.com/atom.xml" rel="self"/>
  <link href="http://atomic-penguin.github.com/"/>
  <updated>2012-08-27T16:08:56-04:00</updated>
  <id>http://atomic-penguin.github.com/</id>
  <author>
    <name><![CDATA[Eric G. Wolfe]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Foodfight podcast - Episode 17, Testing with Eric G. Wolfe & Fletcher Nichol]]></title>
    <link href="http://atomic-penguin.github.com/blog/2012/06/12/Foodfight-17-Testing-with-Eric-and-Fletcher/"/>
    <updated>2012-06-12T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2012/06/12/Foodfight-17-Testing-with-Eric-and-Fletcher</id>
    <content type="html"><![CDATA[<p>I had such a blast at the inaugural Chefconf in San Francisco, CA.  This was my first time visiting the area, I had a chance to visit the <a href="https://plus.google.com/112791157300091682319/posts/2Dr6BMnBqHH">Alcatraz</a> prison.  I also drank a lot of <a href="http://www.anchorbrewing.com/beer/anchor_steam">Anchor Steam</a>, while pair programming with <a href="http://twitter.com/#!fnichol">Fletcher Nichol</a> to make the NTP cookbook a reference cookbook for testing Chef recipes.</p>

<p>During my second appearance on the Food Fight show, we covered what we hacked on throughout Chefconf with regard to Travis CI automated testing.  We also talked a bit about what we are doing internally with Jenkins to test our cookbook code.  Here is the link to the podcast <a href="http://traffic.libsyn.com/foodfight/FoodFightShowEpisode17.mp3">audio</a> and also the show <a href="http://foodfightshow.org/2012/06/episode-17-testing-with-eric-g-wolfe.html">notes</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HOWTO (Video) Simple KVM Virtualization, a Command Line Demonstration]]></title>
    <link href="http://atomic-penguin.github.com/blog/2012/04/04/HOWTO-simple-kvm-virtualization-a-command-line-demonstration/"/>
    <updated>2012-04-04T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2012/04/04/HOWTO-simple-kvm-virtualization-a-command-line-demonstration</id>
    <content type="html"><![CDATA[<p>A simple demonstration using KVM (Kernel-based Virtual Machine) from the command line interface.</p>

<p>Sorry for the slight graphics artefacts, I was testing out some screencast software for the first time.</p>

<p>Watch it on youtube, <a href="http://www.youtube.com/watch?v=aN8lb2O-wHs">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Foodfight podcast - Episode 1, Chef in 2012]]></title>
    <link href="http://atomic-penguin.github.com/blog/2012/01/15/Foodfight-1-Chef-in-2012/"/>
    <updated>2012-01-15T00:00:00-05:00</updated>
    <id>http://atomic-penguin.github.com/blog/2012/01/15/Foodfight-1-Chef-in-2012</id>
    <content type="html"><![CDATA[<p>I was really excited to be part of the first community podcast for Opscode Chef, <a href="http://foodfightshow.org">Food Fight</a>.  Here is a link to the podcast <a href="http://traffic.libsyn.com/foodfight/ff_ep01_2.mp3">audio</a> and also the show <a href="http://foodfightshow.org/2012/01/episode-1-chef-in-2012.html">notes</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Marshall University case study]]></title>
    <link href="http://atomic-penguin.github.com/blog/2011/09/06/MU-case-study/"/>
    <updated>2011-09-06T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2011/09/06/MU-case-study</id>
    <content type="html"><![CDATA[<p>Our System Administration team colloborated with <a href="http://www.ospcode.com/">Opscode</a> to put together a Case Study detailing our use of their System automation framework, Opscode Chef.</p>

<p>Case Study: Opscode + Marshall University <a href="http://www.opscode.com/customers/marshall/">web</a> <a href="http://www.opscode.com/case-studies/opscode-case-study-marshall.pdf">pdf</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2 cent Linux tip using find and tar for a selective backup]]></title>
    <link href="http://atomic-penguin.github.com/blog/2011/07/11/2-cent-linux-tip-using-find-and-tar-for-a-selective-backup/"/>
    <updated>2011-07-11T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2011/07/11/2-cent-linux-tip-using-find-and-tar-for-a-selective-backup</id>
    <content type="html"><![CDATA[<p>So I&#39;m blowing away, and re-installing, my Steam Bottle on <a href="http://codeweavers.com">Codeweaver&#39;s</a> Crossover games.  I was hoping to get some in-game overlay support for the Community/Friends features of Steam.  I really really want to hang on to Team Fortress/Left 4 Dead settings though.</p>

<p>Using the <code>find</code> command we can solve this problem fairly easy.</p>

<!-- more -->


<p>So the basic requirements in this scenario boil down to finding all the config files under the <code>~/.cxgames</code> tree. I have an <code>~/etc</code> directory to keep a backup of important things such as settings and handy scripts. I will copy my tar file to the <code>~/etc</code> directory so I can find it easily later. However, I don&#8217;t want every <code>*.cfg</code> file under my Steam bottle, just the ones for those specific games (Team Fortress and Left 4 Dead). When I run the following command, I&#39;ll discover those games have a common top-level directory, <em>~/.cxgames/Steam/drive_c/Program Files/Steam/steamapps</em>.</p>

<div class="highlight"><pre><code class="bash">    find ~/.cxgames -name <span class="s2">&quot;*.cfg&quot;</span>
</code></pre>
</div>


<p>When I run the following command, however, I&#8217;ll get an error due to spaces in the directory/filename structure.  Note the backslash in &#8220;Program Files&#8221; is an escaped space for the shell to properly interpret this.</p>

<div class="highlight"><pre><code class="bash">    find .cxgames/Steam/drive_c/Program<span class="se">\ </span>Files/Steam/steamapps/ | xargs tar -rf ~/etc/steam-settings.tar
</code></pre>
</div>


<p>The find command has a switch <code>-print0</code> to deal with this, and <code>xargs</code> will process this find output format with the <code>-0</code> flag.  The <code>-print0</code> and <code>-0</code> flags tell these system utilities to print or use null-terminated strings, making it easier for shell utilities to consume the spaces in the filenames.  Therefore the following command will get the files I need:</p>

<div class="highlight"><pre><code class="bash">    find ~/.cxgames/Steam/drive_c/Program Files/Steam/steamapps/ -name <span class="s2">&quot;*.cfg&quot;</span> -print0 | xargs -0 tar -rf ~/etc/steam-settings.tar
</code></pre>
</div>


<p>Restoring is as simple as running the following command from within my home directory.</p>

<div class="highlight"><pre><code class="bash">    tar xvf ~/etc/steam-settings.tar
</code></pre>
</div>


<p>Perhaps some day we&#8217;ll have a Linux steam client, and a promotional TF2 item named the <strong>Unix Pipe</strong>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HOWTO Using rsync to move a mountain of data]]></title>
    <link href="http://atomic-penguin.github.com/blog/2011/04/16/HOWTO-Using-rsync-to-move-a-mountain-of-data/"/>
    <updated>2011-04-16T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2011/04/16/HOWTO-Using-rsync-to-move-a-mountain-of-data</id>
    <content type="html"><![CDATA[<p>In this installment of my blog, I want to document the proper use of rsync for folks who are tasked with moving a large amount of data.  I&#39;ll even show you a few things you can do from the command line interface to extend the built-in capability of rsync using a little bash-scripting trickery.</p>

<p>I use rsync to migrate Oracle databases between servers at least a few times per year.  In a snap, its one of the easiest ways to clone a database from a Production server to a Pre-Production/Development server or even a Virtual Machine.  You don&#8217;t have to have a fancy Fibre-Channel or iSCSI storage array attached to both servers, in order to do a data LUN clone, thanks to rsync.</p>

<p>I hope you enjoy this in-depth article.  Please feel free to comment: if you need clarification, find it useful, or something I wrote is just plain wrong.</p>

<!-- more -->


<h2>The Tools</h2>

<p>Three things you&#8217;ll need for this exercise:</p>

<ol>
<li><code>screen</code> - lets you detach a console session, and can be re-attached after logging out and walking away.</li>
<li><code>rsync</code> - the swiss-army knife of copy/archiving programs.</li>
<li><code>data</code> - any will do. Whether its a large group of /home directories, or even a live Oracle database.</li>
</ol>


<h2>Basics of screen</h2>

<ol>
<li>Simply type <code>screen</code> in the command-line interface.</li>
<li>Kick off a large rsync job that may take several hours to finish</li>
<li><code>ctrl-a d</code> detaches your screen session.  You may then proceed to logout, walk away, and go grab a lunch, or two.</li>
<li>Log back in to the server later, and re-attach your session by running <code>screen -r</code>.</li>
<li>If your connection to the server was interrupted by an unreliable network, screen may throw an error saying the session is already attached, however screen -dr will de-tach and re-attach the session with no problem.</li>
</ol>


<h2>Basics of rsync</h2>

<p>There is a daunting amount of options to be found in the <code>rsync</code> manpage.  An important point to remember is what no-slash and trailing slashes on directories mean.</p>

<p>For instance if I want to copy everything within a folder named <code>/home</code>, I would use <code>rsync -av /home/ /path/to/destination</code> to copy the files within <code>/home</code>, to the folder <code>/path/to/destination</code>.</p>

<p>On the other hand, if I want to copy the folder <code>/home</code> itself to <code>/path/to/destination</code>, then I would use <code>rsync -av /home /path/to/destination</code>, which will then create the folder <code>/path/to/destination/home</code>.</p>

<p>Here are a few of the most important command-line options to remember.</p>

<ul>
<li><code>-v</code>: verbose, will tell you what file its on, how many left to check, etc.</li>
<li><code>-a</code>: archive, will set most of the preferable options, this is shorthand for -rlptgoD. If in doubt, you most always want the -a option.

<ul>
<li><code>-r</code>: recursive</li>
<li><code>-l</code>: copy symlinks as files, not the file to which they point.  Why do you want this? It prevents your rsync job from looping back to a directory above itself, causing an infinite loop, in the case there are a few unruly symlinks in your filesystem tree.</li>
<li><code>-p</code>: preserve permissions</li>
<li><code>-t</code>: preserve modification timestamps</li>
<li><code>-g</code>: preserve group ownership. rsync is smart enough to change the group ID by name, rather than numerical group ID on the destination.</li>
<li><code>-o</code>: preserve ownership. Same behavior applies to user ID by name, rather than numerical ID.</li>
<li><code>-D</code>: preserve special files. Such as device files, named pipes, etc.</li>
</ul>
</li>
</ul>


<p>Some other useful switches</p>

<ul>
<li><code>--progress</code>: gives you per-file data transfer rates, and spinning progress bars if you&#39;re into that sort of thing.</li>
<li><code>--stats</code>: gives you a nice summary rate, and speed-up rate at the end of the job.</li>
</ul>


<h2>Set up a rsync daemon</h2>

<p>If you are cloning a database or migrating a complex ERP system, the fastest way to do that is export a root share for your destination host, by defining it in rsyncd.conf. I typically set up a temporary read-only rsync daemon on the production host.  The reasoning for that is the the client end of rsync will consume more memory as it indexes the list of files to transfer.  Therefore rsync should have less impact by running the job from a pre-production host, while the daemon runs on your production server.</p>

<p>Anyway, the configuration files for the temporary rsync daemon on your production system should look something like this.</p>

<div class="highlight"><pre><code class="bash">    <span class="c">#/etc/rsyncd.conf</span>
    syslog <span class="nv">facility</span> <span class="o">=</span> local3
    <span class="nb">read </span><span class="nv">only</span> <span class="o">=</span> yes <span class="nv">list</span> <span class="o">=</span> yes
    auth <span class="nv">users</span> <span class="o">=</span> root
    secrets <span class="nv">file</span> <span class="o">=</span> /etc/rsyncd.secrets
    hosts <span class="nv">allow</span> <span class="o">=</span> 1.2.3.4/32
    <span class="nv">uid</span> <span class="o">=</span> 0
    <span class="nv">gid</span> <span class="o">=</span> 0

    <span class="o">[</span>root<span class="o">]</span>
    <span class="nv">comment</span> <span class="o">=</span> /
    <span class="nv">path</span> <span class="o">=</span> /
</code></pre>
</div>


<p>Set a password for the daemon in /etc/rsyncd.secrets, and set the owner/group of that file to root:root with 600 permissions.  The password file format looks like this.</p>

<div class="highlight"><pre><code class="bash">    <span class="c">#/etc/rsyncd.secrets</span>
    root:SuperSecretPasswordFTW
</code></pre>
</div>


<p>Open TCP port 873 for the pre-production host, an appropriate iptables rule would look something like this.</p>

<div class="highlight"><pre><code class="bash">    iptables -I INPUT -s preprod-server -m tcp -p tcp --dport 873 --syn -j ACCEPT
</code></pre>
</div>


<p>Finally run the following command to start up your temporary rsync daemon on the production host.</p>

<div class="highlight"><pre><code class="bash">    
    rsync --daemon
</code></pre>
</div>


<p>Now you should have all the components necessary to copy files over the network using the rsync protocol, an rsync client on the pre-production server, and an rsync server on the production server.  Your command should look something like this.</p>

<div class="highlight"><pre><code class="bash">    rsync -av root@prod-server::root/home/ /home
</code></pre>
</div>


<p>Yet another way of saying the same thing, but also copying any special permissions on the top-level directory of home to the /home directory on the pre-prod server.</p>

<div class="highlight"><pre><code class="bash">    rsync -av root@prod-server::root/home /
</code></pre>
</div>


<p>The rsync url components are user (root), followed by an @, hostname (prod-server), followed by a separator (::), followed by the share name (root), followed by the source directory with, or without an optional trailing-slash.</p>

<p>Once the rsync job has finished on the pre-production server, you can run the following to kill off the daemon, and remove your temporary iptables rule.</p>

<div class="highlight"><pre><code class="bash">    killall -9 rsync
    iptables -D INPUT -s preprod-server -m tcp -p tcp --dport 873 --syn -j ACCEPT
</code></pre>
</div>


<h2>Advanced rsync usage</h2>

<h3>block-level replication</h3>

<p>In theory you would want to use the following option to update block-level changes on large files.</p>

<ul>
<li><code>--inplace</code>: rsync writes updated data directly to a file, instead of making a copy and moving it into place.

<ul>
<li>I strongly advise you to RTFM on this one, it comes with several warnings.  But from what I understand, this option was added to rsync for cloning large files such as databases.  Both server&#39;s rsync programs need to support the in-place option for this to work, otherwise it will give you an error.</li>
</ul>
</li>
</ul>


<p>I usually kick off a large rysnc job on a hot database, and run one or even a few catch-up jobs on a cold database before the final switch in any large-scale data migration.  What that means is you can run rsync on a running database, but you will not get a consistent Oracle DBF file on your pre-production host during a hot run.  It doesn&#39;t matter if you use the <code>--inplace</code> option, or not, on the first hot run.  Either way, you probably will not get a consistent copy of the database.</p>

<p>However, on any subsequent cold run (when the database is shut down) <code>--inplace</code> can significantly reduce the amount of data written on the pre-production host.  Because this particular option has the ability to do block-level updates to large files, when used on your final rsync catch-up job.  I have witnessed rsync updating half a Terabyte worth of dbf files in close to half an hour, during a final cold run on a quiet weekend.  I have also seen it take up to four hours to do just as much after close of business on a Friday night.  Your mileage may vary from my results, probably the most significant variable in rsync performance is the amount of usage between the initial hot run and final cold run.</p>

<h3>Extending rsync by automation with Bash</h3>

<p>Lets say you have a long paired list of source and destination directories.  For example, I might want to archive <code>/home/u/user1</code> on the prod server to <code>/home/user1</code> on the pre-prod server.  The rsync rules of the trailing slashes on directories do come into play here.</p>

<p>So after playing around with some perl/sed, and awk to generate a list of source and destinations from a password file on the production server.  I might have a file rsync-home.list containing syntactically correct paired rsync sources and destinations, which would look something like this.</p>

<div class="highlight"><pre><code class="bash">    root@prod-server::root/home/a/alice /home
    root@prod-server::root/home/b/bob /home
    root@prod-server::root/u01/app/oracle /u01/app
    root@prod-server::root/home/c/charlie /home
    root@prod-server::root/home/d/dave /home
    root@prod-server::root/home/e/eve /home
    root@prod-server::root/home/m/mallory /home
    root@prod-server::root/home/t/trent /home
    root@prod-server::root/home/w/walter /home
    root@prod-server::root/usr/local/vendor /usr/local
</code></pre>
</div>


<p>Unfortunately there is no switch for rsync to read such a list, and operate on it directly.  However, it is fairly easy to script with a bash one-liner, like so.</p>

<div class="highlight"><pre><code class="bash">    
    <span class="nv">RSYNC_PASSWORD</span><span class="o">=</span><span class="s2">&quot;SuperSecretPasswordFTW&quot;</span>; cat rsync-home.list | <span class="k">while </span><span class="nb">read </span>LINE; <span class="k">do </span>rsync -av --progress <span class="nv">$LINE</span>; <span class="k">done</span>
</code></pre>
</div>


<p>The <code>RSYNC_PASSWORD</code> is an environment variable you can set to avoid having to type in the actual password for the rsync daemon, just be aware it will show up in your .bash_history file, and output from <code>ps -ef</code>.  So it is advisable to not use the same password as your root account for the purposes of rsync.</p>

<h3>Hunting down symlinks in the archive tree</h3>

<p>Remember when I said you usually don&#39;t want to copy what a symlink points at, rather copy the pointer (symlink file) itself.  If you want a quick and easy way to make a list of symlinked directories within the <code>/u01</code> tree on your production server, you can pair <code>find</code>, and <code>awk</code> commands to generate a list like this. The <code>-type l</code> option tells <code>find</code> to look for symlinks, the <code>-xtype d</code> option tells find to look for symlinks pointing at directories.  The <code>$NF</code> variable in <code>awk</code> returns the last field from the long-list <code>ls -l</code> output.</p>

<div class="highlight"><pre><code class="bash">    find /u01 -type l -xtype d -exec ls -l <span class="o">{}</span> ; | awk <span class="s1">&#39;{ print $NF }&#39;</span>
</code></pre>
</div>


<p>Which returns a handy little list of items remaining to be copied over to our pre-prod server by rsync.  The couple of returned entries without a leading-slash can be thrown out, those are links within the <code>/u01</code> tree and would therefore be copied as a result of running an rsync job on <code>/u01</code>.</p>

<div class="highlight"><pre><code class="bash">    /u04/app/oracle/RMAN
    /u03/app/oracle/arclogs
    /u05/app/oracle/exports
    /u02/app/oracle/oradata/fooprod
    /u06/app/oracle/oradata/foopreprd
    client
    /u08
    linux
</code></pre>
</div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Red Hat Enterprise Linux 5.x iSCSI and Device Mapper Multipath HOWTO]]></title>
    <link href="http://atomic-penguin.github.com/blog/2010/11/29/Red-Hat-Enterprise-Linux-5.x-iSCSI-and-device-mapper-multipath-HOWTO/"/>
    <updated>2010-11-29T00:00:00-05:00</updated>
    <id>http://atomic-penguin.github.com/blog/2010/11/29/Red-Hat-Enterprise-Linux-5.x-iSCSI-and-device-mapper-multipath-HOWTO</id>
    <content type="html"><![CDATA[<h2>Abstract</h2>

<p><img src="http://atomic-penguin.github.com/images/muwam.png" alt="Marshall University Systems Infrastructure Team" /></p>

<p>This document outlines in a detailed step-by-step fashion,
how to properly configure iSCSI initiator, and multi-path I/O
software on Red Hat Enterprise Linux version 5.</p>

<pre><code>Copyright © 2010, Marshall University Systems Infrastructure Team
Author: Eric G. Wolfe 
Contributor: Jaymz Mynes 
Editor: Tim Calvert 

Marshall University 
400 Hal Greer Blvd. 
Huntington, WV 25755 

This work is licensed under the Creative Commons Attribution-Noncommercial-Share 
Alike 3.0 United States License. To view a copy of this license, 
visit http://creativecommons.org/licenses/by-nc-sa/3.0/us/ 
or send a letter to Creative Commons, 171 Second Street, Suite 
300, San Francisco, California, 94105, USA. 

The block M logo is a trademark of Marshall University. All other 
trademarks are owned by their respective owners. 
</code></pre>

<!-- more -->


<h2>I. Introduction</h2>

<p>The following configuration was documented and tested on a Dell
Poweredge R710, with RedHat Enterprise Linux 5.0 x64. The R710
server has 4 Broadcom NeteXtreme II BCM5709 Gigabit Network
Interface Cards (NIC), and is connected by Ethernet to an EqualLogic
PS6000 storage array.</p>

<p>This step-by-step guide is directly applicable to these software
and hardware components. However, much of the software configuration
would remain the same for any Linux distribution
on either X86 or AMD64
based hardware. The most dynamic variable in any case will be
specific storage solutions. Consider any factors that your
storage vendor may support, or recommend, before proceeding.</p>

<h3>II. Hardware Preparation</h3>

<p>Appropriate hardware preparation is beyond the scope of this
document. See vendor documentation for connecting Ethernet
cables to the storage array, and appropriate configuration
of the storage array. According to Dell EqualLogic (2008) some
recommended guidelines are as follows:</p>

<ul>
<li><p>Do&#8230;</p></li>
<li><p>Do NOT&#8230;</p></li>
</ul>


<p>See <em>PS Series Array Network Performance Guidelines</em>, or relevant
storage vendor&#8217;s documentation for more information.</p>

<p>III. Manual Installation</p>

<p>The following section outlines manual installation and configuration
of Device Mapper Multipath and Open-iSCSI initiator on Red Hat
Enterprise Linux version 5.x. If this is your first time installing
and configuring Device Mapper Multipath, or Open-iSCSI software,
then this is the recommended method of installation and configuration.
It is possible to automate a portion of this installation and
configuration with Red Hat&#8217;s Kickstart, or configuration management
engines such as Puppet. However, that is beyond the scope of this
document.</p>

<p>The methods outlined in this guide apply directly to Red Hat Enterprise
Linux, {text:change} {text:change-start} though {text:change-end}
a major portion of the configuration items are generic and could
be applied to other Linux distributions. The author of this HOWTO
assumes these steps will, for the most part, remain constant
for subsequent versions of Red Hat Enterprise Linux.</p>

<h2>1. Package Installation</h2>

<p>After performing a base install of Red Hat Enterprise v5, make
sure to upgrade the system to the latest patch-level.</p>

<blockquote><p>Change this line in <em>/etc/yum.conf</em> as illustrated below.</p></blockquote>

<p>exclude=kernel*</p>

<blockquote><p>Comment out the exclude options, so the kernel may be upgraded.</p></blockquote>

<p>exclude=#kernel*</p>

<blockquote><p>Run the following to upgrade to the latest patch-level.</p></blockquote>

<p>yum -y upgrade</p>

<blockquote><p>Run the following to install needed software.</p></blockquote>

<p>{text:change-start} yum -y install iscsi-initiator-utils
device-mapper-multipath {text:change-end}</p>

<p>Dell Equallogic (2009) recommends using RHEL 5.4 (version 5
update 4) or newer for best performance and interoperability
with PS Series storage arrays. Ensure the following requirements
are met before proceeding.</p>

<blockquote><p>Run the following to check for minimum package versions.</p></blockquote>

<p>rpm -qa iscsi-initiator-utils device-mapper-multipath</p>

<p>device-mapper-multipath-<version>-<patch-level>.el5</p>

<p>iscsi-initiator-utils-<version>-<patch-level>.el5</p>

<blockquote></blockquote>

<ul>
<li><p>Minimum package version for PS Series arrays</p></li>
<li><p>Minimum package version for GbE NICs</p></li>
<li><p>With SELinux enabled, you may not be able to login to iSCSI targets.
You may have to create a policy for iSCSI traffic, or disable
{text:change} {text:change-start} SELinux {text:change-end}
.</p></li>
</ul>


<p>After updating the kernel, you will need to reboot the system,
before proceeding. This would be a good time to pick an appropriate
I/O scheduler. Available I/O schedulers, and the kernel option
to select them, are as follows.</p>

<ul>
<li><p>Completely Fair Queueing – elevator=cfq</p></li>
<li><p>Deadline – {text:change-start} <strong>elevator=deadline</strong>
{text:change-end}</p></li>
<li><p>NOOP – {text:change-start} <strong>elevator=noop</strong> {text:change-end}</p></li>
<li><p>Anticipatory – elevator=as</p></li>
</ul>


<p>According to a citation in Dell Equallogic (2009), the Open-iSCSI
group reports that sometimes the NOOP scheduler works best for
iSCSI server environments. However, if this server will be used
as an Oracle database or application server, it is standard best
practice to use the Deadline scheduler for optimal performance.</p>

<blockquote><p>Run the following command to enable the NOOP scheduler, before
rebooting.</p></blockquote>

<p>sed -e &#8216;s!/vmlinuz.*!&amp; elevator=noop!g&#8217; -i /boot/grub/menu.lst</p>

<blockquote><p>If you are provisioning an Oracle server, then run the following
to select Deadline.</p></blockquote>

<p>sed -e &#8216;s!/vmlinuz.*!&amp; elevator=deadline!g&#8217; -i /boot/grub/menu.lst</p>

<p>Finally, reboot the server after upgrading the system and kernel.
Do this before proceeding with the configuration steps that
follow {text:change} {text:change} so the proper I/O scheduler
will be active and the newer kernel will be available. You may
also want to go back and uncomment the <em>exclude=#kernel*</em> line
in <em>/etc/yum.conf</em>, at your own discretion.</p>

<p>IV. Configuring Open-iSCSI</p>

<h3>1. Configuring the NIC cards for iSCSI use</h3>

<p>In the following example, it is assumed you will be using the third
(eth2) and fourth (eth3) Network Interface Cards in the system
for iSCSI traffic. If this is not the case, then adjust the configuration
for different NICs as necessary.</p>

<p>Add the following bold lines to each of the <em>ifcfg-ethX</em> scripts
for each iSCSI NIC. Ensure that <em>IPADDR</em>, and <em>NETMASK</em> are correctly
set for your iSCSI subnet. Make sure <em>ONBOOT</em> is set to <em>yes</em>.
This is set so that each interface will be automatically initialized
when the system is booted. The <em>MTU</em> variable should be set to
<em>9000</em>, for each iSCSI NIC, this MTU setting will enable jumbo
frames.</p>

<p><em>/etc/sysconfig/</em> {text:change} {text:change-start} <em>network-scripts</em>
{text:change-end} <em>/ifcfg-eth2</em></p>

<h1>Broadcom Corporation NetXtreme II BCM5709 Gigabit Ethernet</h1>

<p>DEVICE=eth2</p>

<p>HWADDR=00:11:22:33:44:aa</p>

<p>ONBOOT=yes</p>

<p>BOOTPROTO=none</p>

<p>NETMASK=255.255.255.0</p>

<p>IPADDR=10.1.2.3</p>

<p>TYPE=Ethernet</p>

<p>MTU=9000</p>

<p><em>/etc/sysconfig/network</em> {text:change} {text:change-start}
<em>-scripts</em> {text:change-end} <em>/ifcfg-eth3</em></p>

<h1>Broadcom Corporation NetXtreme II BCM5709 Gigabit Ethernet</h1>

<p>DEVICE=eth3</p>

<p>HWADDR=00:11:22:33:44:bb</p>

<p>ONBOOT=yes</p>

<p>BOOTPROTO=none</p>

<p>NETMASK=255.255.255.0</p>

<p>IPADDR=10.1.2.4</p>

<p>TYPE=Ethernet</p>

<p>MTU=9000</p>

<p>Dell EqualLogic (2009) recommends enabling Flow Control, and
disabling Auto Negotiation on each iSCSI NIC. For these settings
to be automatically applied upon each boot, add the following
code, in boldface, to the <em>/etc/rc.local</em> file.</p>

<p>/etc/rc.local</p>

<h1>iSCSI Interface Settings for Equallogic</h1>

<p>ISCSI_IF=&#8221;eth2 eth3&#8221;</p>

<p>ETHTOOL_OPTS=&#8221;autoneg off rx on tx on&#8221;</p>

<p>ETHTOOL=<code>which ethtool</code></p>

<p>for i in $ISCSI_IF;</p>

<p>do</p>

<p>echo &#8220;$ETHTOOL -A $i $ETHTOOL_OPTS&#8221;</p>

<p>$ETHTOOL -A $ISCSI_IF $ETHTOOL_OPTS</p>

<p>done</p>

<p>1.1. Configuring Open-iSCSI initiator utilities</p>

<p>You need to tune a few lines in the <em>/etc/iscsi/iscid.conf</em> file,
per vendor recommendations. You can grep out blank and comment
lines in this file for quick inspection. The lines we are most
concerned {text:change-start} about {text:change-end} will
appear in bold. Values set per specific vendor recommendations
are highlighted in red.</p>

<h4>1.1.1. Notes about iscsid.conf configuration</h4>

<p>As I understand it, the configuration item, <em>node.session.timeo.replacement_timeout</em>
is for specifying the length of time, in seconds, {text:change-start}
after {text:change-end} which the iSCSI layer will fail back
to the Device Mapper Multipath application layer. By default,
this is 120 seconds, or 2 minutes. According to Red Hat (2008),
it is preferable to pass the path failure quickly from the SCSI
layer to your Multipath software, which would be necessary for
quick fail-over. With the default configuration, two minutes
of I/O would be queued before failing the path. If you are familiar
with Fiber Channel path fail-over, it tends to be instantaneous.
Most people configuring iSCSI fail-over certainly don&#8217;t want
a failed path to be retried for two whole minutes. Using the default
configuration with a production database server could lead
to massive amounts of I/O being queued {text:change} {text:change-start}
i {text:change-end} nstead of the expected behavior of failing
over to another working path quickly. Changing this value to
15 {text:change} {text:change} will {text:change-start}
allow the path to failover {text:change-end} {text:change}
much {text:change} {text:change-start} more quickly {text:change-end}
.</p>

<p>According to Dell (2010), if the Broadcom bnx2i interface fails
to login to an Equallogic iSCSI storage volume, the <em>node.session.initial_login_retry_max</em>
should be changed from the default value of <em>8</em> to <em>12</em> {text:change-end}
{text:change} {text:change-start} .</p>

<p>According to Dell Equallogic (2009) the options <em>node.session.cmds_max</em>,
and <em>node.session.queue_depth</em> should be changed for Equallogic
arrays. The recommendation for <em>node.session.cmds_max</em> is
to change the value from <em>128</em> {text:change-end} {text:change}
{text:change-start} _ to <strong>1024</strong>. <em>The recommendation for
</em>node.session.queue_depth<em> is to change the value from </em>32<em>
{text:change-end} {text:change} {text:change} {text:change-start}
to </em>128_.</p>

<p>Finally, according to the in-line comments in the default iscsid.conf,
and Dell (2010) Equallogic arrays should have <em>node.session.isci.FastAbort</em>
set to <em>No</em>. If using software such as iSCSI Enterprise Target
(IET), instead of an Equallogic Array, leave the <em>FastAbort</em>
value set to the default, which is <em>Yes</em>. {text:change-end}</p>

<p>1.1.2. iscsid.conf {text:change}</p>

<p>egrep -v “<sup>(#|$)”</sup> /etc/iscsi/iscid.conf</p>

<p>node.startup = automatic</p>

<p><strong>node.session.timeo.replacement_timeout = </strong><strong>15</strong>**</p>

<h1>default 120; RedHat recommended**</h1>

<p>node.conn[0].timeo.login_timeout = 15</p>

<p>node.conn[0].timeo.logout_timeout = 15</p>

<p>node.conn[0].timeo.noop_out_interval = 5</p>

<p>node.conn[0].timeo.noop_out_timeout = 5</p>

<p>node.session.err_timeo.abort_timeout = 15</p>

<p>node.session.err_timeo.lu_reset_timeout = 20</p>

<p><strong>node.session.initial_login_retry_max = </strong><strong>12</strong><strong> # default
8; Dell recommended</strong></p>

<p><strong>node.session.cmds_max = </strong><strong>1024</strong><strong> # default 128; Equallogic
recommended</strong></p>

<p><strong>node.session.queue_depth = </strong><strong>128</strong><strong> # default 32; Equallogic
recommended</strong></p>

<p>node.session.iscsi.InitialR2T = No</p>

<p>node.session.iscsi.ImmediateData = Yes</p>

<p>node.session.iscsi.FirstBurstLength = 262144</p>

<p>node.session.iscsi.MaxBurstLength = 16776192</p>

<p>node.conn[0].iscsi.MaxRecvDataSegmentLength = 262144</p>

<p>discovery.sendtargets.iscsi.MaxRecvDataSegmentLength
= 32768</p>

<p>node.conn[0].iscsi.HeaderDigest = None</p>

<p><strong>node.session.iscsi.FastAbort = </strong><strong>No</strong><strong> # default Yes;
Dell / Open-iSCSI recommended</strong></p>

<h1>IV. Targeting and Logging in with iscsiadm</h1>

<h2>1. Create iSCSI interfaces</h2>

<p>The iSCSI interfaces are separate pseudo-devices used by Open-iSCSI.
From Open-iSCSI&#8217;s point-of-view, these are not the same as physical
Ethernet devices. What you&#8217;ll need to do is bind {text:change-start}
each of {text:change-end} your ethX devices to an iSCSI interface.
Technically speaking, you could call your iSCSI interfaces
{text:change} {text:change} eth2 and eth3, and bind them to
the corresponding physical devices in the /dev folder. To avoid
any confusion about physical NICs and iSCSI interfaces, it {text:change-start}
’ {text:change-end} s {text:change} recommended to give the
interfaces different names like iface0 and iface1.</p>

<p>{text:change} {text:change-start} You can {text:change-end}
create your iSCSI interfaces with the following commands.</p>

<p>iscsiadm -m iface -I iface0 -o new</p>

<p>iscsiadm -m iface -I iface1 -o new</p>

<p>Second, let {text:change-start} ’ {text:change-end} s {text:change}
take a look at the iSCSI interface properties for one of our new
interfaces. This will come in handy to view the currently active
configuration {text:change} {text:change} in cases where
you need to troubleshoot {text:change} .</p>

<p>{text:change-start} {text:change-end} {text:change-start}
This is how you can look at the iSCSI interface properties for
one of the new interfaces. {text:change-end} {text:change-start}
Being able to view the currently active configuration can come
in handy in cases where you need to troubleshoot. {text:change-end}
{text:change-start} {text:change-end}</p>

<p>iscsiadm -m iface -I iface0</p>

<p>{text:soft-page-break} # BEGIN RECORD 2.0-871</p>

<p>iface.iscsi_ifacename = iface0</p>

<p>iface.net_ifacename = <empty></p>

<p>iface.ipaddress = <empty></p>

<p>iface.hwaddress = <empty></p>

<p>iface.transport_name = tcp</p>

<p>iface.initiatorname = <empty></p>

<h1>END RECORD</h1>

<h2>2. Bind iSCSI interfaces</h2>

<p>Now that we have iSCSI interfaces, we need to bind them to a physical
Ethernet device. You can use either a device name {text:change}
{text:change} or MAC address. Open-iSCSI won&#8217;t even let you
bind the interfaces with both {text:change} a device name {text:change}
{text:change} and MAC address.</p>

<p>Binding by physical device name</p>

<p>iscsiadm -m iface {text:change-start} -o update {text:change-end}
-I iface0 -n iface.net_ifacename -v eth2</p>

<p>iscsiadm -m iface {text:change-start} -o update {text:change-end}
-I iface1 -n iface.net_ifacename -v eth3</p>

<p>Binding by MAC address</p>

<p>iscsiadm -m iface {text:change-start} -o update {text:change-end}
-I iface0 -n iface.hwaddress -v 00:aa:bb:cc:dd:ee</p>

<p>iscsiadm -m iface {text:change-start} -o update {text:change-end}
-I iface1 -n iface.hwaddress -v 00:aa:bb:cc:dd:ff</p>

<p>An important note about alternate transport drivers for iSCSI
offload: By default, your new iSCSI interfaces will use TCP as
the iSCSI transport. There are other offload transport drivers
available to use, such as <strong>bnx2i</strong>, <strong>iser</strong>, and <strong>cxgb3i</strong>.
According to the iscsiadm manual page and personal conversation
with a Dell storage engineer, these are experimental drivers
which are not supported or considered stable.</p>

<h3>2.1. Updating iSCSI interfaces</h3>

<p>If you bind an interface by MAC address, and have a hardware replacement
which changes the MAC address. Then the iSCSI interface bindings
will need {text:change-start} to be {text:change-end} updated
{text:change} {text:change} to reflect such system changes.
You can do this with {text:change} {text:change-start} an {text:change-end}
update command {text:change} {text:change} {text:change-start}
: {text:change-end}</p>

<p>iscsiadm -m iface -o update -I iface0 -n iface.hwaddress -v 00:aa:bb:cc:dd:11</p>

<p>iscsiadm -m iface -o update -I iface1 -n iface.hwaddress -v 00:aa:bb:cc:dd:33</p>

<h2>3. Connecting to the iSCSI array</h2>

<p>The file <em>/etc/iscsi/initiatorname.iscsi</em> should contain
an initiator name for your iSCSI client host. You need to include
this initiator name on your iSCSI array&#8217;s configuration for
this specific iSCSI client host.</p>

<p>If you haven&#8217;t yet started the iSCSI daemon, run the following
command before we commence with discovering targets.</p>

<p>{text:soft-page-break}</p>

<p>service iscsid start</p>

<h3>3.1 Discovering targets</h3>

<p>Once the iscsid service is running {text:change} {text:change}
and the client&#8217;s initiator name is configured on the iSCSI array
{text:change} {text:change} {text:change-start} , {text:change-end}
then you may proceed with the following command to discover available
targets. Assuming our iSCSI array had an IP address of 10.1.2.10,
the following command would return the available targets.</p>

<p>iscsiadm -m discovery -t st -p 10.1.2.10:3260</p>

<p>10.1.2.10:3260,1 iqn.2001-05.com.equallogic:0-8a0906-7008ec504-23d000000204bad0-hostname-vol0</p>

<p>10.1.2.10:3260,1 iqn.2001-05.com.equallogic:0-8a0906-7008ec504-23d000000204bad0-hostname-vol0</p>

<h3>3.2. Login to target</h3>

<p>We&#8217;re finally ready to login to our target {text:change} {text:change}
{text:change-start} . {text:change-end} {text:change} {text:change-start}
T {text:change-end} o log in to all targets, use the following
command. This should return successful {text:change} {text:change}
if everything is working correctly.</p>

<p>iscsiadm -m node -l</p>

<p>Individual targets can be logged into {text:change} {text:change}
by specifying a whole target name.</p>

<p><strong>iscsiadm -m node -T </strong><strong><em>iqn.2001-05.com.equallogic:0-8a0906-7008ec504-23d000000204bad0-hostname-vol0
-l -p 10.1.2.10:3260</em></strong></p>

<h3>3.3. Logoff a target</h3>

<p>Logging off is basically the same as logging into a target, except
you use <em>-u</em> {text:change} {text:change} instead of <em>-l.</em></p>

<p>iscsiadm -m node -u</p>

<h3></h3>

<p>3.4. Session status</p>

<p>The session command can be used to print the basic status {text:change}
{text:change} or more verbose output for debugging and troubleshooting.</p>

<p>Basic command {text:change} {text:change-start} : {text:change-end}</p>

<p>iscsiadm -m session</p>

<p>tcp: [10] 10.1.2.10:3260,1 iqn.2001-05.com.equallogic:0-8a0906-7008ec504-23d000000204bad0-hostname-vol0</p>

<p>tcp: [9] 10.1.2.10:3260,1 iqn.2001-05.com.equallogic:0-8a0906-7008ec504-23d000000204bad0-hostname-vol0</p>

<p>Troubleshooting information with -P (print) flag {text:change}
{text:change} and verbosity level 0-3 {text:change} {text:change-start}
: {text:change-end}</p>

<p>iscsiadm -m session -P3</p>

<p>iSCSI Transport Class version 2.0-871</p>

<p>version 2.0-871</p>

<p>Target: iqn.2001-05.com.equallogic:0-8a0906-7008ec504-23d000000204bad0-hostname-vol0</p>

<p>Current Portal: 10.1.2.25:3260,1</p>

<p>Persistent Portal: 10.1.2.10:3260,1</p>

<hr />

<p>Interface:</p>

<hr />

<p>Iface Name: iface0</p>

<p>Iface Transport: tcp</p>

<p>Iface Initiatorname: iqn.1994-05.com.redhat:13c39f80866f</p>

<p>Iface IPaddress: 10.1.2.3</p>

<p>Iface HWaddress: <empty></p>

<p>Iface Netdev: eth2</p>

<p>SID: 10</p>

<p>iSCSI Connection State: LOGGED IN</p>

<p>iSCSI Session State: LOGGED_IN</p>

<p>Internal iscsid Session State: NO CHANGE</p>

<hr />

<p>Negotiated iSCSI params:</p>

<hr />

<p>HeaderDigest: None</p>

<p>DataDigest: None</p>

<p>MaxRecvDataSegmentLength: 262144</p>

<p>MaxXmitDataSegmentLength: 65536</p>

<p>FirstBurstLength: 65536</p>

<p>MaxBurstLength: 262144</p>

<p>ImmediateData: Yes</p>

<p>InitialR2T: No</p>

<p>MaxOutstandingR2T: 1</p>

<hr />

<p>Attached SCSI devices:</p>

<hr />

<p>Host Number: 27 State: running</p>

<p>scsi27 Channel 00 Id 0 Lun: 0</p>

<p>Attached scsi disk sdc State: running</p>

<p>V. Configuring Device Mapper Multipath</p>

<h2>1. Notes about the Device Mapper Multipath example</h2>

<p>The final major step is to configure Device Mapper Multipath
{text:change} {text:change} using the configuration file
<em>/etc/multipath.conf</em>. By default there will be a <em>devnode
“*”</em> line in the <em>blacklist</em> section, thereby disabling Multipath
for all devices in the system. If you want to assign persistently
bound names to iSCSI devices, {text:change} be sure to set <em>user_friendly_names</em>
to yes, as seen in the example on the following page. If you do not
use friendly names with Device Mapper, you&#8217;ll end up with device
names such as <em>/dev/mapper/__36090afffffffffffffffffffffffffff</em>.
When using friendly names, you&#8217;ll need to specify an <em>alias</em>
line in the <em>multipaths</em> section after Open-iSCSI is configured
and working correctly with your iSCSI target {text:change}
{text:change} or array.</p>

<p>You will want to blacklist any local devices that do not have multiple
paths to be managed {text:change} {text:change} in the <em>blacklist</em>
section. It is recommended to blacklist the local SCSI disks
by World Wide Identifier (WWID). The WWID is a unique identifier
for any block device {text:change} {text:change} and may be
retrieved with the command <em>scsi_id -g -u -s /block/sdX</em>, where
X is the letter identifier of the local SCSI disk. It cannot hurt
to also blacklist local devices by physical device name with
a <em>devnode</em> line and a Perl-compatible regular expression string.
The reason for blacklisting a second time with a regular expression
is in case the <em>scsi_id</em> program fails to read the WWID from sector
zero of a local device. See the blacklist section in the configuration
example. The WWID line {text:change} {text:change} and _devnode
“<sup>sd[a]$”_</sup> line both serve as a blacklist for device sda.</p>

<p>Once you have discovered targets {text:change} {text:change}
and logged in to the iSCSI array, you can use the &#8217;<em>iscsiadm -m
session -P3&#8217;</em> command to find the physical device names of your
iSCSI volumes. Then you can use {text:change} {text:change}
the &#8217;<em>scsi_id -g -u -s /block/sdX&#8217;</em> command to find the WWID of
your iSCSI volumes. Once you have the WWIDs of your iSCSI volumes,
you can configure friendly name aliases in the <em>multipaths</em>
section, as seen {text:change-start} in the example {text:change-end}
on the next page {text:change} .</p>

<p>The device section in the configuration example is pertinent
to an Equallogic PS Series array. The lines in boldface type are
of particular importance, and are the recommended defaults
for Equallogic devices. You can override the parameters on a
per-volume basis in the <em>multipaths</em> section.</p>

<p>{text:change-start} For best performance, {text:change-end}
{text:change} {text:change-start} t {text:change-end} he
value for <em>rr_min_io</em> should {text:change} {text:change-start}
be {text:change-end} in the range of {text:change-start} <em>10-20</em>
{text:change-end} for database environments. {text:change-start}
For {text:change-end} {text:change} {text:change-start}
m {text:change-end} ore sequential loads {text:change-start}
, {text:change-end} which may be seen on file servers, {text:change}
{text:change-start} performance might be better if {text:change-end}
<em>rr_min_io</em> {text:change} is set in the range {text:change-start}
<em>100-512</em> {text:change-end} . Any <em>rr_min_io</em> value over {text:change-start}
<em>200</em> {text:change-end} will require max commands and queue
depths parameters in <em>iscsid.conf</em> to be increased.</p>

<p>1.1. multipath.conf</p>

<p>defaults {</p>

<p>user_friendly_names yes</p>

<p>}</p>

<p>blacklist {</p>

<p>wwid 360924fffffffffffffffffffffffffff</p>

<p>devnode &#8221;<sup>sd[a]$&#8221;</sup></p>

<p>devnode &#8221;<sup>(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*&#8221;</sup></p>

<p>devnode &#8221;<sup>hd[a-z][[0-9]*]&#8221;</sup></p>

<p>devnode &#8221;<sup>cciss!c[0-9]d[0-9]<em>[p[0-9]</em>]&#8221;</sup></p>

<p>}</p>

<p>devices {</p>

<p>device {</p>

<p><strong>vendor &#8220;EQLOGIC&#8221;</strong></p>

<p><strong>product &#8220;100E-00&#8221;</strong></p>

<p>path_grouping_policy multibus</p>

<p>getuid_callout &#8220;/sbin/scsi_id -g -u -s /block/%n&#8221; {text:change}</p>

<p>{text:change-start} <strong>no_path_retry </strong> {text:change-end}
{text:change} {text:change} {text:change-start} {text:change-start}
<strong>queue</strong> {text:change-end} {text:change-end}</p>

<p>path_checker readsector0</p>

<p>failback immediate</p>

<p>path_selector &#8220;round-robin 0&#8221;</p>

<p><strong>rr_min_io 10</strong></p>

<p>rr_weight priorities</p>

<p>}</p>

<p>}</p>

<p>multipaths {</p>

<p>multipath {</p>

<p>wwid 36090afffffffffffffffffffffffffff</p>

<p>alias u02</p>

<p>}</p>

<p>}</p>

<h2>1.2. Start and test Device Mapper Multipath</h2>

<p>Device Mapper Multipath can be started with the following command
{text:change} {text:change} once it has been configured.</p>

<p>service multipathd start</p>

<p>You can list the Multipath topology with the following command
to verify everything is working correctly.</p>

<p>multipath -ll -v2</p>

<p>u02 (36090a04850ec0870d0ba04020000d023) dm-0 EQLOGIC,100E-00</p>

<p>[size=100G][features=0][hwhandler=0][rw]</p>

<p>_ round-robin 0 [prio=2][active]</p>

<p>_ 10:0:0:0 sdb 8:16 [active][ready]</p>

<p>_ 11:0:0:0 sdc 8:32 [active][ready]</p>

<h2>{text:soft-page-break} 1.3. Reload udev to test friendly alias names</h2>

<p>Once Multipath has been verified to be working correctly, {text:change}
you may need to run the following <em>udev</em> command to create {text:change-start}
devices with {text:change-end} friendly name {text:change-start}
s {text:change-end} {text:change} . This only applies if you
have chosen to use persistent Multipath binding by defining
<em>alias</em> lines in the <em>multipaths</em> section of <em>multipath.conf</em>.
Reloading udev {text:change} {text:change} will automagically
{text:change} create your aliased devices in the <em>/dev/mapper</em>
folder.</p>

<p>Reload udev command {text:change} {text:change} {text:change-start}
: {text:change-end}</p>

<p>udevcontrol reload_rules</p>

<p>You may proceed to <em>fdisk</em> {text:change} {text:change} and
format the aliased device, just as you would any other SCSI disk
device appearing in the /dev directory.</p>

<h1>VI. Final steps</h1>

<h2>1. Set services to start automatically.</h2>

<p>Once you have everything up and running, with regards to Open-iSCSI
and Device Mapper Multipath, {text:change} run the following
commands to ensure services get started automatically during
server boot {text:change-start} {text:change-end} up {text:change}
.</p>

<p>Set the iscsid daemon to start automatically {text:change}
{text:change} {text:change-start} : {text:change-end}</p>

<p>chkconfig iscsid on</p>

<p>Set the iscsi service to log in to targets automatically {text:change}
{text:change} {text:change-start} : {text:change-end}</p>

<p>chkconfig iscsi on</p>

<p>Set the multipathd daemon to start automatically {text:change}
{text:change} {text:change-start} : {text:change-end}</p>

<p>chkconfig multipathd on</p>

<p>Edit <em>/etc/fstab</em>, and add a line with the <strong>netdev_ keyword
for all your volumes to be mounted. Using the </strong>netdev_ keyword
ensures this device will not be mounted before the networking
subsystem has started. {text:change-start}</p>

<p>We&#8217;ve observe {text:change-end} {text:change-start} d Open-iSCSI
failing both paths temporarily while updating firmware on the
group node. {text:change-end} {text:change-start} This could
result in a machine remounting a filesystem in read-only mode
upon error unless an &#8217;<em>errors=continue</em>&#8217; option is added to
/etc/fstab. {text:change-end}</p>

<p>LABEL=/ {text:change} / {text:change} ext3 defaults 1 1</p>

<p>LABEL=/u01 {text:change} /u01 {text:change} ext3 defaults
1 2</p>

<p>/dev/mapper/u02p1 {text:change} /u02 {text:change} {text:change}
ext3 _netdev,defaults {text:change-start} ,errors=continue
{text:change-end} 0 0</p>

<p>tmpfs {text:change} /dev/shm {text:change} tmpfs defaults
0 0</p>

<p>devpts {text:change} /dev/pts {text:change} devpts gid=5,mode=620
0 0</p>

<p>sysfs {text:change} /sys {text:change} sysfs defaults 0 0</p>

<p>proc {text:change} /proc {text:change} {text:change} proc
defaults 0 0</p>

<p>LABEL=SWAP-sda5 {text:change} swap {text:change} swap defaults
0 0</p>

<h2>2. Final testing</h2>

<h3>2.1. Reboot</h3>

<p>Reboot your server, and make sure everything comes up. The iscsi
initialization script should log the server in to the iSCSI targets.
Multipath should be started, and {text:change-start} it should
{text:change-end} see both of its paths to the iSCSI array. If
everything is working correctly, the <em>fstab</em> entry should automatically
mount any iSCSI volumes.</p>

<h3>2.2. Test your Multipath software</h3>

<p>The easiest way to test your Multipath software is to take down
one of the Ethernet devices manually. {text:change-start}
To do this, {text:change-end} {text:change} {text:change-start}
r {text:change-end} un the following command.</p>

<p>ifdown eth3</p>

<p>After about 15 seconds you should see something like this in the
messages log.</p>

<p>kernel: device-mapper: multipath: Failing path X:XX</p>

<p>multipathd: <alias>: remaining active paths: 1</p>

<p>Then, bring the device back up manually {text:change} {text:change}
{text:change-start} : {text:change-end}</p>

<p>ifup eth3</p>

<p>Again, after about 15 seconds you should see something like this
in the messages log.</p>

<p>multipathd: X:XX: reinstated</p>

<p>multipathd: <alias>: remaining active paths: 2</p>

<p>Repeat this test for every other NIC being used for iSCSI {text:change}
{text:change} and make sure every iSCSI Network Interface fails-over
from faulty paths, and reinstate {text:change} all active iSCSI
paths {text:change} {text:change} gracefully.</p>

<p>References and recommended reading</p>

<p>Aizman, Alex, and Dmitry Yusupov. 2007. Open-iSCSI – RFC3720
architecture and implementation. <em>Open-iSCSI project</em>. <a href="http://www.open-iscsi.org/index.html#docs">http://www.open-iscsi.org/index.html#docs</a>.</p>

<blockquote><p>Anon. Device-mapper Resource Page. <em>Device-Mapper-Multipath
Project</em>. <a href="http://sources.redhat.com/dm/">http://sources.redhat.com/dm/</a>.</p>

<p>Dell EqualLogic, Inc. 2008. <em>PS Series Array Network Performance
Guidelines</em>. 3rd ed. Nashua, NH: Dell, Inc, June. <a href="http://www.equallogic.com/uploadedfiles/Resources/Tech_Reports/tr-network-guidelines-TR1017.pdf">http://www.equallogic.com/uploadedfiles/Resources/Tech_Reports/tr-network-guidelines-TR1017.pdf</a>.</p>

<p>———. 2009. <em>Red Hat Linux v5.x Software iSCSI Initiator Configuration,
MPIO and tuning Guide</em>. Nashua, NH: Dell, Inc, December. <a href="http://www.equallogic.com/resourcecenter/assetview.aspx?id=8727">http://www.equallogic.com/resourcecenter/assetview.aspx?id=8727</a>.</p>

<p>Red Hat, Inc. 2007. How do I configure the iscsi-initiator in
Red Hat Enterprise Linux 5? <em>Red Hat Knowledgebase</em>. June 25.
<a href="http://access.redhat.com/kb/docs/DOC-6388">https://access.redhat.com/kb/docs/DOC-6388</a>.</p>

<p>———. 2008. How can I improve the failover time of a faulty path
when using device-mapper-multipath over iSCSI? <em>Red Hat Knowledgebase</em>.
October 1. <a href="https://access.redhat.com/kb/docs/DOC-2877">https://access.redhat.com/kb/docs/DOC-2877</a>.</p>

<p>———. 2010a. <em>DM Multipath</em>. <a href="http://www.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5.5/html/DM_Multipath/index.html">http://www.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5.5/html/DM_Multipath/index.html</a>.</p>

<p>———. 2010b. Kickstart Installations. In <em>Installing Red Hat
Enterprise Linux 5 for all architectures</em>, Chap. 31. Research
Triangle Park, NC: Red Hat, Inc. <a href="http://www.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5.5/html/Installation_Guide/index.html">http://www.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5.5/html/Installation_Guide/index.html</a>.</p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2 Cent Tip - Extend (resize) a whole device partition.]]></title>
    <link href="http://atomic-penguin.github.com/blog/2010/09/02/2-cent-tip-extend-resize-a-whole-device-partition/"/>
    <updated>2010-09-02T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2010/09/02/2-cent-tip-extend-resize-a-whole-device-partition</id>
    <content type="html"><![CDATA[<p>Occasionally I have to resize partitions on iSCSI or Fiber-Channel attached SAN storage.  Both technologies allow you to easily extend the available storage for a host by extending LUNs, or volumes.  A common problem after extending the size of the LUN, or volume, is resizing partitions to fill out the new size.</p>

<p>For the most part, I usually fire up <a href="http://partedmagic.com">PartedMagic</a> and its a snap, even with Fiber-Channel attached enterprise storage.  Once the HBAs (Host Bus Adapters) have been zoned to Fiber-Channel switches, then the HBAs do all the heavy lifting.  In other words on Fiber-Channel, it doesn&#8217;t matter if you&#8217;re using PartedMagic, or <a href="http://www.knopper.net">Knoppix</a>, the server just knows where the storage is and whether it is in an attached state.  The only dependency for this working on a Live boot disk are drivers for the HBA cards.</p>

<!-- more -->


<p>iSCSI is a bit different.  Because, iSCSI relies on commodity Network Interface Cards, this technology is largely implemented in software.  One perceived advantage is iSCSI may seem less complicated to use than Fiber-Channel storage.  Unfortunately, in this case, PartedMagic did not have open-iscsi software, and I could install open-iscsi in the Knoppix Live ramdisk. However, because Knoppix came with an outdated iSCSI kernel module, it was not new enough to inter-operate with the open-iscsi software.</p>

<p>Furthermore, the version of <a href="http://www.gnu.org/software/parted/index.shtml">parted</a> that shipped with RHEL 5 threw an incompatible filesystem error, refusing to modify the filesystem. So, in the end, I twiddled some bits on the partition table with fdisk, and used resize2fs to extend the partition.</p>

<p>Assuming you have a backup of the filesystem you are working on, you can proceed with the following steps to extend a single partition to the end of the extended volume.  If you have multiple partitions on a volume, you may want to stick to more reliable methods of resizing and extending.  If you screw up the cylinder boundaries on a device with multiple partitions, you&#8217;ll definitely lose data.  A single partition, in this example, is a much simpler scenario.</p>

<p>The device name in this example is <code>/dev/mapper/u02</code>, the first partition is <code>/dev/mapper/u02p1</code>:</p>

<p>Run <code>fdisk -l /dev/mapper/u02</code> to get the starting cylinder.</p>

<div class="highlight"><pre><code class="bash">    root@localhost:~# fdisk -l /dev/mapper/u02
    Disk /dev/mapper/u02: 100.9 GB, 108340550042 bytes

    255 heads, 63 sectors/track, 13171 cylinders
    <span class="nv">Units</span> <span class="o">=</span> cylinders of 16065 * <span class="nv">512</span> <span class="o">=</span> 8225280 bytes

              Device Boot      Start         End      Blocks   Id  System
    /dev/mapper/u02p1               1       13171   26450329   83  Linux
</code></pre>
</div>


<p>Reboot the server after extending the volume or LUN on your SAN.  You want to do this before extending the partition in your Operating System.  The Operating System needs to re-read sector 0 on the extended SAN volume, before continuing. Note, that fdisk will report <strong>26109</strong> cylinders instead of <strong>13171</strong>, after rebooting the server.</p>

<p>Next, we will run: <code>fdisk /dev/mapper/u02</code>, and then hit the keys: <code>d, n, p, 1, [enter], [enter], w</code></p>

<div class="highlight"><pre><code class="bash">    root@localhost:~# fdisk /dev/mapper/u02
    WARNING: DOS-compatible mode is deprecated. It<span class="s1">&#39;s strongly recommended to</span>
<span class="s1">             switch off the mode (command &#39;</span>c<span class="s1">&#39;) and change display units to</span>
<span class="s1">             sectors (command &#39;</span>u<span class="err">&#39;</span><span class="o">)</span>.

    Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: d
    Selected partition 1

    Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: n
    Command action
       e   extended
       p   primary partition <span class="o">(</span>1-4<span class="o">)</span>
    p
    Partition number <span class="o">(</span>1-4<span class="o">)</span>: 1
    First cylinder <span class="o">(</span>1-26109, default 1<span class="o">)</span>:
    Using default value 1
    Last cylinder, +cylinders or +size<span class="o">{</span>K,M,G<span class="o">}</span> <span class="o">(</span>1-26109, default 26109<span class="o">)</span>:
    Using default value 26109

    Command <span class="o">(</span>m <span class="k">for </span><span class="nb">help</span><span class="o">)</span>: w
    The partition table has been altered!

    Calling ioctl<span class="o">()</span> to re-read partition table.
    Syncing disks.
</code></pre>
</div>


<p>Finally, run <code>resize2fs</code> on <code>/dev/mapper/u02p1</code>. If you are using ext3, you can do an on-line resize while the volume is mounted.  It is probably safest to <code>umount</code> the partition to be re-sized, however.</p>

<div class="highlight"><pre><code class="bash">    root@localhost:~# resize2fs /dev/mapper/u02p1
    resize2fs 1.39 <span class="o">(</span>29-May-2006<span class="o">)</span>
    Filesystem at /dev/mapper/u02p1 is mounted on /u02; on-line resizing required
    Performing an on-line resize of /dev/mapper/u02p1 to 52430127 <span class="o">(</span>4k<span class="o">)</span> blocks.
    The filesystem on /dev/mapper/u02p1 is now 52430127 blocks long.
</code></pre>
</div>


<p>Refer to the <code>resize2fs</code> for more information on the command, and its proper usage.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2 Cent Tip - Dynamic rdesktop resolution.]]></title>
    <link href="http://atomic-penguin.github.com/blog/2010/06/28/2-cent-tip-dynamic-rdesktop-resolution/"/>
    <updated>2010-06-28T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2010/06/28/2-cent-tip-dynamic-rdesktop-resolution</id>
    <content type="html"><![CDATA[<p>So occasionally I do have to touch a Windows system, or use a Windows-only management tool (I&#8217;m looking at you VMware).  Not that I have any problem with Microsoft or Windows, I&#8217;m really just more comfortable in a Unix-like environment.  I do use the Open Source <code>rdesktop</code> utility to access Windows machine using version 5.0 of the Remote Desktop Protocol (RDP).</p>

<p>It&#8217;s a handy utility, but I really wish it would give me an appropriate resolution based on the current resolution of my laptop&#8217;s X Windows session.  There is, in fact, a command line flag to alter the geometry of the remote desktop window.  However, typing in <code>rdesktop -g 1280x1024</code> is much more tedious than typing in <code>rdesktop</code> on the command line interface.</p>

<!-- more -->


<p>So the simple solution is to put an alias in the <code>.bashrc</code> file, like so&#8230;</p>

<div class="highlight"><pre><code class="bash">    <span class="c"># ~/.bashrc</span>
    <span class="nv">rdesktop</span><span class="o">=</span><span class="s1">&#39;rdesktop -g 1280x1024&#39;</span>
</code></pre>
</div>


<p>However, on my laptop, the max resolution without an external monitor is 1600x900.  So I still have to override the setting with <code>rdesktop -g 1280x1024</code> on the command line, any time I am running without an external monitor.</p>

<p>Another solution would be to use <code>awk</code> to find a smaller resolution from <code>xrandr</code>, then set that resolution in my <code>rdesktop</code> alias.</p>

<div class="highlight"><pre><code class="bash">    <span class="c"># ~/.bashrc</span>
    <span class="nv">RDESKTOP_SIZE</span><span class="o">=</span><span class="sb">`</span>xrandr | awk <span class="s1">&#39;{getline; getline; getline; print $1; exit;}&#39;</span><span class="sb">`</span>

    <span class="nb">alias </span><span class="nv">rdesktop</span><span class="o">=</span><span class="s1">&#39;rdesktop -g $RDESKTOP_SIZE&#39;</span>
</code></pre>
</div>


<p>This <code>awk</code> command will skip the first three lines, from the xrandr output.  That is two header lines, and the maximum resolution on the following line, which we&#8217;ll skip.  I&#8217;ll take the next highest resolution and set that in the variable <code>$RDESKTOP_SIZE</code>.  Finally, I&#8217;ll use the variable <code>$RDESKTOP_SIZE</code> with the <code>-g</code> switch in <code>rdesktop</code> to properly set my alias.</p>

<p>Let us say you have two big monitors plugged into a port replicator.  Perhaps you only want the <code>rdesktop</code> window to cover part of one screen.  The following code will keep my <code>rdesktop</code> window smaller than one of the 1920x1200 screens on a spanned 3840x1200 resolution.</p>

<div class="highlight"><pre><code class="bash">    <span class="c"># ~/.bashrc</span>
    <span class="nv">RDESKTOP_SIZE</span><span class="o">=</span><span class="sb">`</span>xrandr | awk <span class="s1">&#39;{getline; getline; getline; print $1; exit;}&#39;</span><span class="sb">`</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$RDESKTOP_SIZE</span> <span class="o">==</span> <span class="s2">&quot;3840x1200&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">RDESKTOP_SIZE</span><span class="o">=</span><span class="s2">&quot;1820x1100&quot;</span>
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">alias </span><span class="nv">rdesktop</span><span class="o">=</span><span class="s1">&#39;rdesktop -g $RDESKTOP_SIZE&#39;</span>
</code></pre>
</div>


<p>In other words, if I have two monitors at 1920x1200 each, their combined resolution is reported by <code>xrandr</code> as 3840x1200.  I want to override the detected resolution to 100 pixels less than the resolution on one screen.  Therefore I set the <code>$RDESKTOP_SIZE</code> variable to 1820x1100, before setting my <code>rdesktop</code> alias in <code>.bashrc</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ohio Linuxfest 2009 - How I learned to stop worrying, and love PXE booting]]></title>
    <link href="http://atomic-penguin.github.com/blog/2009/09/26/Ohio-Linuxfest-How-I-learned-to-stop-worrying-and-love-PXE-booting/"/>
    <updated>2009-09-26T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2009/09/26/Ohio-Linuxfest-How-I-learned-to-stop-worrying-and-love-PXE-booting</id>
    <content type="html"><![CDATA[<p>These are my presentation slides for the 2009 Ohio Linuxfest.  I gave a talk on the topic of network and multi-booting with Syslinux and configuring systems with Kickstart.</p>

<ul>
<li><a href="http://syslinux.zytor.com">Syslinux</a> website.</li>
<li>How I learned to stop worrying, and love PXE booting <a href="http://atomic-penguin.github.com/papers/olf-2009-pxe-booting">slides</a>.</li>
<li>Presentation <a href="http://ia700404.us.archive.org/15/items/OhioLinuxfest2009/43-Eric_Wolfe-How_I_Learned_to_Stop_Worrying_and_Love_PXE_Booting_vbr.mp3">audio</a> on Archive.org</li>
<li>Linux server installed with Oracle pre-requisites, in 15 minutes or less, on <a href="http://www.youtube.com/watch?v=h_oHe-WDE9U">Youtube</a>.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ohio Linuxfest 2008 - Square Pegs in Round Holes, Linux in a Windows World]]></title>
    <link href="http://atomic-penguin.github.com/blog/2008/10/11/Ohio-Linuxfest-Square-Pegs-in-Round-Holes-Linux-in-a-Windows-World/"/>
    <updated>2008-10-11T00:00:00-04:00</updated>
    <id>http://atomic-penguin.github.com/blog/2008/10/11/Ohio-Linuxfest-Square-Pegs-in-Round-Holes-Linux-in-a-Windows-World</id>
    <content type="html"><![CDATA[<p>These are my presentation slides for the 2008 Ohio Linuxfest.  I gave a well recieved talk on the topic of Windows, and Active Directory, Linux integration using Samba.  My <a href="https://atomic-penguin.github.com/cookbook-krb5">krb5</a> handles the krb5.conf and pam configurations outlined in the examples below.</p>

<!-- more -->


<ul>
<li><a href="http://atomic-penguin.github.com/papers/Square_Pegs_in_Round_Holes_Linux_in_a_Windows.ppt">Slides</a></li>
<li><a href="https://github.com/atomic-penguin/dnsnarf">DNSnarf</a>.  This code is deprecated now in favor of the bind::ldap2zone recipe, included in the Opscode Chef cookbook, <a href="https://atomic-penguin.github.com/cookbook-bind">bind</a></li>
</ul>


<p>Example config files</p>

<h2>/etc/krb5.conf</h2>

<p>Example Kerberos 5.0 configuration for Active Directory domain CONTOSO.COM.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Example Kerberos configuration for CONTOSO.COM kerberos realm</span>
</span><span class='line'><span class="c"># kdc01.contoso.com and kdc03.contoso.com are Windows domain controllers</span>
</span><span class='line'><span class="c"># for this environment.</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>logging<span class="o">]</span>
</span><span class='line'> <span class="nv">default</span> <span class="o">=</span> FILE:/var/log/krb5libs.log
</span><span class='line'> <span class="nv">kdc</span> <span class="o">=</span> FILE:/var/log/krb5kdc.log
</span><span class='line'> <span class="nv">admin_server</span> <span class="o">=</span> FILE:/var/log/kadmind.log
</span><span class='line'>
</span><span class='line'><span class="o">[</span>libdefaults<span class="o">]</span>
</span><span class='line'> <span class="nv">default_realm</span> <span class="o">=</span> CONTOSO.COM
</span><span class='line'> <span class="nv">dns_lookup_realm</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span><span class="nv">dns_lookup_kdc</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb"> </span><span class="nv">ticket_lifetime</span> <span class="o">=</span> 24h
</span><span class='line'> <span class="nv">forwardable</span> <span class="o">=</span> yes
</span><span class='line'>
</span><span class='line'><span class="o">[</span>realms<span class="o">]</span>
</span><span class='line'> CONTOSO.COM <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">kdc</span> <span class="o">=</span> kdc01.contoso.com
</span><span class='line'>  <span class="nv">kdc</span> <span class="o">=</span> kdc03.contoso.com
</span><span class='line'>  <span class="nv">admin_server</span> <span class="o">=</span> kdc01.contoso.com
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>domain_realm<span class="o">]</span>
</span><span class='line'> contoso.com <span class="o">=</span> CONTOSO.COM
</span><span class='line'> .contoso.com <span class="o">=</span> CONTOSO.COM
</span><span class='line'>
</span><span class='line'><span class="o">[</span>appdefaults<span class="o">]</span>
</span><span class='line'> <span class="nv">pam</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>   <span class="nv">debug</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="nb">   </span><span class="nv">ticket_lifetime</span> <span class="o">=</span> 36000
</span><span class='line'>   <span class="nv">renew_lifetime</span> <span class="o">=</span> 36000
</span><span class='line'>   <span class="nv">forwardable</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">   </span><span class="nv">krb4_convert</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>/etc/samba/smb.conf</h2>

<p>Example Samba 3 configuration for Active Directory/Winbind integration</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This is an example of how to setup Samba as a domain member </span>
</span><span class='line'><span class="c"># of CONTOSO.COM to provide file services.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># The winbind method used in this example works much like a Windows</span>
</span><span class='line'><span class="c"># Domain Member file server in resolving usernames and groups over RPC.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># idmap provides predictable UID and GID</span>
</span><span class='line'><span class="c"># generation based on the user&#39;s domain SID number</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>global<span class="o">]</span>
</span><span class='line'>unix <span class="nv">charset</span> <span class="o">=</span> LOCALE
</span><span class='line'><span class="nv">workgroup</span> <span class="o">=</span> CONTOSO
</span><span class='line'><span class="nv">realm</span> <span class="o">=</span> CONTOSO.COM
</span><span class='line'>server <span class="nv">string</span> <span class="o">=</span> Contoso File Server
</span><span class='line'><span class="nv">security</span> <span class="o">=</span> ADS
</span><span class='line'>allow trusted <span class="nv">domains</span> <span class="o">=</span> no
</span><span class='line'>log <span class="nv">level</span> <span class="o">=</span> 1
</span><span class='line'>log <span class="nv">file</span> <span class="o">=</span> /var/log/samba/%m.log
</span><span class='line'>max log <span class="nv">size</span> <span class="o">=</span> 50
</span><span class='line'>idmap <span class="nv">backend</span> <span class="o">=</span> rid:CONTOSO<span class="o">=</span>1000-1000000
</span><span class='line'>idmap <span class="nv">uid</span> <span class="o">=</span> 1000-1000000
</span><span class='line'>idmap <span class="nv">gid</span> <span class="o">=</span> 1000-1000000
</span><span class='line'>winbind cache <span class="nb">time</span> <span class="o">=</span> 3600
</span><span class='line'>winbind enum <span class="nv">groups</span> <span class="o">=</span> yes
</span><span class='line'>winbind use default <span class="nv">domain</span> <span class="o">=</span> yes
</span><span class='line'>winbind normalize <span class="nv">names</span> <span class="o">=</span> yes
</span><span class='line'>admin <span class="nv">users</span> <span class="o">=</span> @CONTOSO<span class="se">\d</span>omain_admins
</span><span class='line'>map acl <span class="nv">inherit</span> <span class="o">=</span> yes
</span><span class='line'>disable <span class="nv">netbios</span> <span class="o">=</span> no
</span></code></pre></td></tr></table></div></figure>


<h2>/etc/httpd/conf.d/auth_kerb.conf</h2>

<p>Example mod_auth_kerb configuration file for Apache2 authentication against Active Directory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This is an example of how to setup Kerberos</span>
</span><span class='line'><span class="c"># authentication in Apache against CONTOSO.COM and</span>
</span><span class='line'><span class="c"># SUBDOMAIN.CONTOSO.COM.  The end result works much</span>
</span><span class='line'><span class="c"># like Windows Integrated Authentication.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Load the module into Apache</span>
</span><span class='line'>LoadModule auth_kerb_module modules/mod_auth_kerb.so
</span><span class='line'>
</span><span class='line'><span class="c"># Directory to protect with Kerberos authentication</span>
</span><span class='line'>&lt;Location /path/to/directory&gt;
</span><span class='line'>  AuthType Kerberos
</span><span class='line'>  AuthName <span class="s2">&quot;Contoso Login&quot;</span>
</span><span class='line'>  KrbMethodNegotiate Off
</span><span class='line'>  KrbMethodK5Passwd On
</span><span class='line'>  KrbSaveCredentials On
</span><span class='line'>  KrbVerifyKDC Off
</span><span class='line'>  KrbAuthRealms CONTOSO.COM SUBDOMAIN.CONTOSO.COM
</span><span class='line'>  Krb5KeyTab /etc/httpd/conf.d/auth_kerb.keytab
</span><span class='line'>  Require valid-user
</span><span class='line'>&lt;/Location&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>/etc/httpd/conf.d/auth_kerb.keytab</h2>

<p>Example mod_auth_kerb keytabl for Apache2 authentication against Active Directory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This is an example of how to setup Kerberos</span>
</span><span class='line'><span class="c"># authentication in Apache against CONTOSO.COM and</span>
</span><span class='line'><span class="c"># SUBDOMAIN.CONTOSO.COM.  The end result works much</span>
</span><span class='line'><span class="c"># like Windows Integrated Authentication.</span>
</span><span class='line'>
</span><span class='line'>HTTP/webserv1.contoso.com@CONTOSO.COM
</span><span class='line'>HTTP/webserv1.contoso.com@SUBDOMAIN.CONTOSO.COM
</span></code></pre></td></tr></table></div></figure>


<h2>/etc/pam.d/system-auth</h2>

<p>Example PAM configuration file for Kerberos 5 authentication against Active Directory Domain.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This file contains the primary system-authentication rules allowing</span>
</span><span class='line'><span class="c"># Kerberos authentication with PAM integrated services such as SSH.</span>
</span><span class='line'><span class="c"># Also configured in this example:</span>
</span><span class='line'><span class="c"># * md5 passwords</span>
</span><span class='line'><span class="c"># * shadow password file</span>
</span><span class='line'><span class="c"># * local authentication, in addition to Kerberos</span>
</span><span class='line'>
</span><span class='line'><span class="c">#%PAM-1.0</span>
</span><span class='line'><span class="c"># This file is auto-generated.</span>
</span><span class='line'><span class="c"># User changes will be destroyed the next time authconfig is run.</span>
</span><span class='line'>auth        required      pam_env.so
</span><span class='line'>auth        sufficient    pam_unix.so nullok try_first_pass
</span><span class='line'>auth        requisite     pam_succeed_if.so uid &gt;<span class="o">=</span> 500 quiet
</span><span class='line'>auth        sufficient    pam_krb5.so use_first_pass
</span><span class='line'>auth        required      pam_deny.so
</span><span class='line'>
</span><span class='line'>account     required      pam_unix.so broken_shadow
</span><span class='line'>account     sufficient    pam_localuser.so
</span><span class='line'>account     sufficient    pam_succeed_if.so uid &lt; 500 quiet
</span><span class='line'>account     <span class="o">[</span><span class="nv">default</span><span class="o">=</span>bad <span class="nv">success</span><span class="o">=</span>ok <span class="nv">user_unknown</span><span class="o">=</span>ignore<span class="o">]</span> pam_krb5.so
</span><span class='line'>account     required      pam_permit.so
</span><span class='line'>
</span><span class='line'>password    requisite     pam_cracklib.so try_first_pass <span class="nv">retry</span><span class="o">=</span>3
</span><span class='line'>password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok
</span><span class='line'>password    sufficient    pam_krb5.so use_authtok
</span><span class='line'>password    required      pam_deny.so
</span><span class='line'>
</span><span class='line'>session     optional      pam_keyinit.so revoke
</span><span class='line'>session     required      pam_limits.so
</span><span class='line'>session     <span class="o">[</span><span class="nv">success</span><span class="o">=</span>1 <span class="nv">default</span><span class="o">=</span>ignore<span class="o">]</span> pam_succeed_if.so service in crond quiet use_uid
</span><span class='line'>session     required      pam_unix.so
</span><span class='line'>session     optional      pam_krb5.so
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
